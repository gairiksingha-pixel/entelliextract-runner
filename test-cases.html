<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EntelliExtract — intellirevenue</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon" />
    <style>
      :root {
        --bg: #f3f3f3;
        --surface: #ffffff;
        --text: #1a1a1a;
        --text-secondary: #505050;
        --border: #b4b4b4;
        --border-light: #d6d6d6;
        --header-bg: #217346;
        --header-text: #ffffff;
        --header-border: #1a5c38;
        --accent: #217346;
        --accent-light: #e6f2eb;
        --primary: #217346;
        --primary-hover: #1a5c38;
        --pass: #217346;
        --pass-bg: #e6f2eb;
        --fail: #c00000;
        --fail-bg: #ffebee;
        --muted: #7f7f7f;
        --row-alt: #f9f9f9;
        --cell-pad: 0.85rem 1rem;
      }
      * {
        box-sizing: border-box;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", "Calibri", Candara, Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.4;
        font-size: 14px;
        display: flex;
        flex-direction: column;
      }
      .header {
        flex-shrink: 0;
        background: var(--surface);
        border-bottom: 2px solid var(--border);
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }
      .header-inner {
        max-width: 100%;
        margin: 0 auto;
        padding: 0.9rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1.5rem;
        flex-wrap: wrap;
      }
      .header-right {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-shrink: 0;
      }
      .header-field-wrap {
        display: grid;
        grid-template-columns: auto minmax(11rem, 1fr);
        grid-template-rows: auto minmax(1.25em, auto);
        align-items: center;
        column-gap: 0.5rem;
        row-gap: 0.2rem;
        justify-content: start;
      }
      .header-field-wrap > .header-label {
        grid-column: 1;
        grid-row: 1;
      }
      .header-field-wrap > .header-select {
        grid-column: 2;
        grid-row: 1;
      }
      .header-field-wrap > .header-field-error {
        grid-column: 2;
        grid-row: 2;
      }
      .header-field-error {
        color: var(--fail);
        font-size: 0.75rem;
        min-height: 1.25em;
        line-height: 1.2;
      }
      .header .logo {
        height: 36px;
        width: auto;
        display: block;
        object-fit: contain;
      }
      .header .logo-placeholder {
        height: 36px;
        display: flex;
        align-items: center;
        font-weight: 600;
        color: var(--accent);
        font-size: 1.1rem;
      }
      .header-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        white-space: nowrap;
        font-weight: 600;
      }
      .header-select {
        width: 176px;
        min-width: 176px;
        max-width: 176px;
        height: 36px;
        padding: 0.5rem 2rem 0.5rem 0.6rem;
        border: 1px solid var(--border);
        background: var(--surface);
        color: var(--text);
        font-size: 0.875rem;
        font-family: inherit;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23505050' d='M2.5 4.5L6 8l3.5-3.5H2.5z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        box-sizing: border-box;
      }
      .header-select:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        background: var(--row-alt);
      }
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 1.25rem 1.5rem;
        max-width: 100%;
      }
      .table-section {
        flex: 9 1 0%;
        min-height: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: var(--surface);
        border: 1px solid var(--border);
        box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      }
      .table-section table {
        height: 100%;
      }
      .bottom-panel {
        flex: 1 1 0%;
        min-height: 80px;
        max-height: 20vh;
        margin-top: 1rem;
        padding: 1rem 1.25rem;
        background: var(--surface);
        border: 1px solid var(--border);
        box-shadow: 0 1px 2px rgba(0,0,0,0.06);
        overflow: auto;
        display: flex;
        flex-direction: column;
      }
      .bottom-panel-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text);
        margin: 0 0 0.75rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border);
      }
      .bottom-panel-content {
        flex: 1;
        font-size: 0.85rem;
        color: var(--text-secondary);
        line-height: 1.5;
      }
      .bottom-panel-content p {
        margin: 0 0 0.5rem 0;
      }
      .bottom-panel-placeholder {
        color: var(--muted);
        font-style: italic;
      }
      .bottom-panel-content code {
        background: var(--row-alt);
        padding: 0.15rem 0.35rem;
        border-radius: 2px;
        font-size: 0.85em;
        border: 1px solid var(--border-light);
      }
      .table-section table {
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
        font-size: 0.9rem;
        background: var(--surface);
      }
      th, td {
        padding: var(--cell-pad);
        text-align: left;
        border: 1px solid var(--border);
        vertical-align: middle;
      }
      thead tr {
        height: 48px;
      }
      thead th {
        height: 48px;
        box-sizing: border-box;
      }
      tbody {
        height: 100%;
      }
      tbody tr {
        height: 50%;
      }
      tbody td {
        height: 50%;
        box-sizing: border-box;
      }
      thead th {
        background: var(--header-bg);
        color: var(--header-text);
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: none;
        letter-spacing: 0.02em;
        border-color: var(--header-border);
      }
      tbody tr {
        background: var(--surface);
      }
      tbody tr:nth-child(even) {
        background: var(--row-alt);
      }
      tbody tr:hover td {
        background: #eff7f2;
      }
      .op-name {
        width: 280px;
        min-width: 280px;
        max-width: 280px;
        font-weight: 600;
      }
      thead th.op-name {
        color: var(--header-text);
      }
      tbody td.op-name {
        background: var(--header-bg);
        color: #ffffff;
        border-color: var(--header-border);
      }
      tbody tr:hover td.op-name {
        background: var(--header-bg);
      }
      .limits-col {
        width: 140px;
        min-width: 140px;
        max-width: 140px;
      }
      .limits-cell {
        font-size: 0.85rem;
        color: var(--text-secondary);
        overflow: hidden;
      }
      .limits-cell .limit-row {
        display: grid;
        grid-template-columns: auto 56px;
        gap: 0.5rem 0.75rem;
        align-items: center;
      }
      .limits-cell .limit-label {
        white-space: nowrap;
        font-weight: 500;
      }
      .limits-cell input[type="number"] {
        width: 56px;
        min-width: 56px;
        max-width: 56px;
        height: 32px;
        padding: 0.35rem 0.4rem;
        border: 1px solid var(--border);
        font-size: 0.875rem;
        box-sizing: border-box;
      }
      .limits-cell .limit-hint {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--muted);
        font-style: italic;
      }
      .limits-cell .n/a {
        color: var(--muted);
        font-style: italic;
      }
      .run-cell {
        width: 220px;
        min-width: 220px;
        max-width: 220px;
        text-align: center;
        vertical-align: middle;
      }
      .run-cell .btn-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: center;
        width: fit-content;
        margin: 0 auto;
        min-width: 186px;
      }
      .run-cell .btn-row {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: nowrap;
        width: 100%;
      }
      .btn-row-download {
        display: flex;
        gap: 0.5rem;
        width: 100%;
        box-sizing: border-box;
      }
      .btn-row-download button {
        flex: 1;
        min-width: 0;
      }
      button.run {
        background: var(--primary);
        color: #fff;
        border: 1px solid var(--header-border);
        padding: 0.65rem 1.25rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        min-width: 5rem;
      }
      button.run:hover {
        background: var(--primary-hover);
      }
      button.run:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }
      button.reset-case {
        background: var(--surface);
        color: var(--text-secondary);
        border: 1px solid var(--border);
        padding: 0.55rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
      }
      button.reset-case:hover {
        background: var(--row-alt);
        color: var(--text);
      }
      button.reset-case.stop-btn {
        background: var(--fail);
        color: #fff;
        border-color: var(--fail);
      }
      button.reset-case.stop-btn:hover {
        background: #a00;
        border-color: #a00;
        color: #fff;
      }
      button.download-sync-report-btn,
      button.download-report-btn {
        border: none;
        padding: 0.55rem 0.85rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        box-sizing: border-box;
      }
      button.download-sync-report-btn {
        background: #2f5496;
        color: #fff;
      }
      button.download-sync-report-btn:hover {
        background: #244a7a;
        color: #fff;
      }
      button.download-report-btn {
        background: var(--accent);
        color: #fff;
      }
      button.download-report-btn:hover {
        background: var(--primary-hover);
        color: #fff;
      }
      button.download-sync-report-btn:disabled,
      button.download-report-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .result-header {
        width: 460px;
        min-width: 460px;
        max-width: 460px;
      }
      .result-cell {
        width: 460px;
        min-width: 460px;
        max-width: 460px;
        vertical-align: top;
        overflow: hidden;
        position: relative;
      }
      .result {
        position: absolute;
        top: 0.85rem;
        left: 1rem;
        right: 1rem;
        bottom: 0.85rem;
        font-family: "Consolas", "Courier New", monospace;
        font-size: 0.8rem;
        padding: 0.6rem 0.75rem;
        white-space: pre-wrap;
        word-break: break-word;
        border: 1px solid var(--border-light);
        background: #fafafa;
        overflow: auto;
        box-sizing: border-box;
      }
      .result.pass {
        background: var(--pass-bg);
        border-color: #a8d4b8;
      }
      .result.fail {
        background: var(--fail-bg);
        border-color: #f5c2c2;
      }
      .result.running {
        background: var(--accent-light);
        border-color: #a8d4b8;
      }
      .result.running .loading-dots::after {
        content: "";
        animation: loading-dots 1.2s steps(4, end) infinite;
      }
      @keyframes loading-dots {
        0%, 20% { content: ""; }
        40% { content: "."; }
        60% { content: ".."; }
        80%, 100% { content: "..."; }
      }
      .result .sync-progress-wrap {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
      }
      .result .sync-progress-bar {
        height: 8px;
        background: var(--border-light);
        overflow: hidden;
        margin-top: 0.35rem;
        max-width: 14rem;
      }
      .result .sync-progress-fill {
        height: 100%;
        background: var(--accent);
        transition: width 0.15s ease-out;
      }
      .result .sync-progress-fill.sync-progress-indeterminate {
        animation: sync-indeterminate 1.2s ease-in-out infinite;
      }
      @keyframes sync-indeterminate {
        0%, 100% { transform: translateX(-100%); }
        50% { transform: translateX(150%); }
      }
      .result.result-placeholder .result-placeholder-text {
        color: var(--muted);
        font-size: 0.85rem;
        font-style: italic;
      }
      .result .exit {
        font-weight: 600;
        margin-bottom: 0.2rem;
        color: var(--text);
      }
      .result .out {
        color: var(--text-secondary);
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-inner">
        <img
          src="/assets/logo.png"
          alt="intellirevenue"
          class="logo"
          id="logo-img"
        />
        <span class="logo-placeholder" style="display: none"
          >intellirevenue</span
        >
        <div class="header-right">
          <div class="header-field-wrap">
            <label class="header-label" for="tenant-select">Brand</label>
            <select id="tenant-select" class="header-select" title="Select brand">
              <option value="">Select</option>
              <option value="all">All</option>
              <option value="no-cow-026090539970-prod">no-cow-026090539970-prod</option>
              <option value="sundia-026090539970-prod">sundia-026090539970-prod</option>
              <option value="tractor-beverage-026090539970-prod">tractor-beverage-026090539970-prod</option>
            </select>
            <div id="brand-error" class="header-field-error" role="alert"></div>
          </div>
          <div class="header-field-wrap">
            <label class="header-label" for="purchaser-select">Purchaser</label>
            <select id="purchaser-select" class="header-select" title="Select purchaser (filtered by brand)">
              <option value="">Select</option>
              <option value="all">All</option>
              <option value="DOT_FOODS">DOT_FOODS</option>
              <option value="KEHE">KEHE</option>
              <option value="UNFI">UNFI</option>
            </select>
            <div id="purchaser-error" class="header-field-error" role="alert"></div>
          </div>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="table-section">
        <table>
          <thead>
            <tr>
              <th class="op-name">Operation</th>
              <th class="limits-col">Batch limits (Sync / Extract)</th>
              <th class="run-cell">Execute</th>
              <th class="result-header">Status &amp; output</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <section class="bottom-panel" aria-label="Reports and run info">
        <h2 class="bottom-panel-title">Reports &amp; run info</h2>
        <div class="bottom-panel-content">
          <p class="bottom-panel-placeholder">After a run, reports are saved to <code>output/reports/</code>. Use the Download Report or Download Sync Report buttons above to save the latest report. This area can show the last run ID and report paths when available.</p>
        </div>
      </section>
    </main>

    <script type="module">
      (function () {
        var logo = document.getElementById("logo-img");
        var placeholder = logo && logo.nextElementSibling;
        if (logo) {
          if (location.protocol === "file:") logo.src = "assets/logo.png";
          logo.addEventListener("error", function () {
            logo.style.display = "none";
            if (placeholder) placeholder.style.display = "flex";
          });
        }
      })();
      const ROWS = [
        { id: "P1", scenario: "S3 Sync — Download files to staging", limits: { sync: true, extract: false } },
        { id: "P2", scenario: "Extract & Report — Run extraction and generate report", limits: { sync: false, extract: true } },
      ];

      function renderLimitsCell(c) {
        const lim = c.limits || { sync: false, extract: false };
        if (!lim.sync && !lim.extract) {
          return '<td class="limits-cell"><span class="n/a">—</span></td>';
        }
        var html = '<td class="limits-cell"><div class="limit-row">';
        if (lim.sync) {
          html +=
            '<span class="limit-label">Sync:</span><input type="number" class="limit-sync" min="0" step="1" value="0" title="Max files to download. 0 = no limit">';
        }
        if (lim.extract) {
          html +=
            '<span class="limit-label">Extract:</span><input type="number" class="limit-extract" min="0" step="1" value="0" title="Max files to extract. 0 = no limit">';
        }
        html += "</div><div class=\"limit-hint\">0 = no limit</div></td>";
        return html;
      }

      function renderRow(c, sectionId) {
        const tr = document.createElement("tr");
        const resultCell = document.createElement("td");
        resultCell.className = "result-cell";
        const resultDiv = document.createElement("div");
        resultDiv.className = "result result-placeholder";
        resultDiv.id = "result-" + c.id;
        resultDiv.innerHTML =
          '<span class="result-placeholder-text">Select Brand and Purchaser above, then click Execute. Leave as All to run for all.</span>';
        resultCell.appendChild(resultDiv);
        const btn = document.createElement("button");
        btn.className = "run";
        btn.textContent = "Run";
        btn.onclick = function () {
          runCase(c.id, btn, resultDiv);
        };
        const resetBtn = document.createElement("button");
        resetBtn.className = "reset-case";
        resetBtn.textContent = "Reset";
        resetBtn.onclick = function () {
          resetCase(resultDiv);
        };
        tr.innerHTML =
          '<td class="op-name">' +
          escapeHtml(c.scenario) +
          "</td>" +
          renderLimitsCell(c) +
          '<td class="run-cell"><div class="btn-group"><div class="btn-row"></div><div class="btn-row-download"></div></div></td>';
        tr.querySelector(".btn-row").appendChild(btn);
        tr.querySelector(".btn-row").appendChild(resetBtn);
        const downloadSyncReportBtn = document.createElement("button");
        downloadSyncReportBtn.className = "download-sync-report-btn";
        downloadSyncReportBtn.textContent = "Download Sync Report";
        downloadSyncReportBtn.type = "button";
        downloadSyncReportBtn.style.display = "none";
        downloadSyncReportBtn.onclick = function () {
          downloadSyncReport(downloadSyncReportBtn);
        };
        tr.querySelector(".btn-row-download").appendChild(downloadSyncReportBtn);
        const downloadReportBtn = document.createElement("button");
        downloadReportBtn.className = "download-report-btn";
        downloadReportBtn.textContent = "Download Report";
        downloadReportBtn.type = "button";
        downloadReportBtn.style.display = "none";
        downloadReportBtn.onclick = function () {
          downloadLatestHtmlReport(downloadReportBtn);
        };
        tr.querySelector(".btn-row-download").appendChild(downloadReportBtn);
        tr.appendChild(resultCell);
        return tr;
      }

      function escapeHtml(s) {
        var div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      function showResult(div, data, pass, progress, syncProgress, caseId) {
        div.style.display = "block";
        var resultClass = "running";
        if (data) resultClass = pass ? "pass" : "fail";
        div.className = "result " + resultClass;
        var row = div.closest("tr");
        var syncCases = ["P1"];
        var extractCases = ["P2"];
        var showSync = data && pass && caseId && syncCases.includes(caseId);
        var showExtract = data && pass && caseId && extractCases.includes(caseId);
        var downloadSyncReportBtn = row ? row.querySelector(".download-sync-report-btn") : null;
        var downloadReportBtn = row ? row.querySelector(".download-report-btn") : null;
        if (downloadSyncReportBtn) {
          downloadSyncReportBtn.style.display = showSync ? "block" : "none";
        }
        if (downloadReportBtn) {
          downloadReportBtn.style.display = showExtract ? "block" : "none";
        }
        if (!data) {
          var label;
          var extra = "";
          if (syncProgress != null && (syncProgress.done != null || syncProgress.total != null)) {
            var done = Number(syncProgress.done) || 0;
            var total = Number(syncProgress.total) || 0;
            label = "Syncing…";
            var pct = total > 0 ? Math.min(100, Math.round((100 * done) / total)) : 0;
            extra =
              '<div class="sync-progress-wrap">Downloads: ' +
              (total > 0 ? done + " / " + total : done + " file(s)") +
              '</div>' +
              (total > 0
                ? '<div class="sync-progress-bar"><div class="sync-progress-fill" style="width:' + pct + '%"></div></div>'
                : '<div class="sync-progress-bar"><div class="sync-progress-fill sync-progress-indeterminate" style="width:40%"></div></div>');
          } else {
            var pctVal = progress && progress.percent != null ? Number(progress.percent) : null;
            var doneVal = progress && progress.done != null ? Number(progress.done) : null;
            var totalVal = progress && progress.total != null ? Number(progress.total) : null;
            if (pctVal != null && totalVal != null && totalVal > 0 && doneVal != null) {
              label = "Running… " + pctVal + "% (" + doneVal + " / " + totalVal + ")";
            } else if (pctVal != null) {
              label = "Running… " + pctVal + "%";
            } else {
              label = "Running…";
            }
          }
          div.innerHTML =
            '<span class="exit">' + escapeHtml(label) + '<span class="loading-dots"></span></span>' + extra;
          return;
        }
        var exit = data.exitCode;
        var stdoutStr = (data.stdout && String(data.stdout).trim()) || "";
        var stderrStr = (data.stderr && String(data.stderr).trim()) || "";
        var syncProgressPrefix = "SYNC_PROGRESS\t";
        var stdoutFiltered = stdoutStr
          ? stdoutStr
              .split("\n")
              .filter(function (line) {
                return line.indexOf(syncProgressPrefix) !== 0;
              })
              .join("\n")
              .trim()
          : "";
        var out = [stdoutFiltered, stderrStr].filter(Boolean).join("\n");
        var noOutput = !out;
        var exitLabel, outHtml;
        if (noOutput) {
          if (exit === 0) {
            exitLabel = "Success";
            outHtml =
              "Command completed successfully with no console output (exit code 0). " +
              "Sync, extraction, or report may have run without printing to stdout/stderr.";
          } else {
            exitLabel = "Failed (exit " + exit + ")";
            outHtml =
              "Command produced no output. Check server logs or run the command in a terminal for details.";
          }
        } else {
          exitLabel = "Exit " + exit;
          outHtml = escapeHtml(out.slice(0, 2000)) + (out.length > 2000 ? "…" : "");
        }
        div.innerHTML =
          '<span class="exit">' + escapeHtml(exitLabel) + '</span>\n<span class="out">' + outHtml + "</span>";
      }

      function resetCase(resultDiv) {
        if (!resultDiv) return;
        resultDiv.innerHTML =
          '<span class="result-placeholder-text">Select Brand and Purchaser above, then click Execute. Leave as All to run for all.</span>';
        resultDiv.className = "result result-placeholder";
        var row = resultDiv.closest("tr");
        if (row) {
          var inputs = row.querySelectorAll(".limit-sync, .limit-extract");
          inputs.forEach(function (input) {
            input.value = "0";
          });
          var downloadSyncReportBtn = row.querySelector(".download-sync-report-btn");
          var downloadReportBtn = row.querySelector(".download-report-btn");
          if (downloadSyncReportBtn) downloadSyncReportBtn.style.display = "none";
          if (downloadReportBtn) downloadReportBtn.style.display = "none";
        }
      }

      function getParamsFromRow(row) {
        var syncInput = row ? row.querySelector(".limit-sync") : null;
        var extractInput = row ? row.querySelector(".limit-extract") : null;
        var syncLimit = syncInput ? Number.parseInt(syncInput.value, 10) : 0;
        var extractLimit = extractInput
          ? Number.parseInt(extractInput.value, 10)
          : 0;
        return {
          syncLimit: Number.isNaN(syncLimit) ? 0 : Math.max(0, syncLimit),
          extractLimit: Number.isNaN(extractLimit)
            ? 0
            : Math.max(0, extractLimit),
        };
      }

      function getTenantPurchaser() {
        var tenantEl = document.getElementById("tenant-select");
        var purchaserEl = document.getElementById("purchaser-select");
        var brandVal = tenantEl && tenantEl.value ? tenantEl.value.trim() : "";
        var purchaserVal = purchaserEl && purchaserEl.value ? purchaserEl.value.trim() : "";
        var tenant = (brandVal === "" || brandVal === "all") ? undefined : brandVal;
        var purchaser = (purchaserVal === "" || purchaserVal === "all") ? undefined : purchaserVal;
        return { tenant: tenant, purchaser: purchaser };
      }

      async function runCase(caseId, btn, resultDiv) {
        var brandEl = document.getElementById("tenant-select");
        var purchaserEl = document.getElementById("purchaser-select");
        var brandVal = brandEl && brandEl.value ? brandEl.value.trim() : "";
        var purchaserVal = purchaserEl && purchaserEl.value ? purchaserEl.value.trim() : "";
        if (brandVal === "") {
          showBrandError("Please select a brand or All.");
          if (purchaserVal && purchaserVal !== "all") showPurchaserError("Please select a brand first.");
          else clearPurchaserError();
          resultDiv.className = "result result-placeholder";
          resultDiv.innerHTML = '<span class="result-placeholder-text">Select a brand first, then select a purchaser or All to run.</span>';
          return;
        }
        if (purchaserVal === "") {
          clearBrandError();
          showPurchaserError("Please select a purchaser or All.");
          resultDiv.className = "result result-placeholder";
          resultDiv.innerHTML = '<span class="result-placeholder-text">Select a brand first, then select a purchaser or All to run.</span>';
          return;
        }
        clearBrandError();
        clearPurchaserError();
        var tp = getTenantPurchaser();
        var row = btn.closest("tr");
        var resetBtn = row ? row.querySelector(".reset-case") : null;
        var controller = new AbortController();
        function restoreResetBtn() {
          if (resetBtn) {
            resetBtn.textContent = "Reset";
            resetBtn.classList.remove("stop-btn");
            resetBtn.onclick = function () {
              resetCase(resultDiv);
            };
          }
        }
        if (resetBtn) {
          resetBtn.textContent = "Stop";
          resetBtn.classList.add("stop-btn");
          resetBtn.onclick = function () {
            controller.abort();
          };
        }
        btn.disabled = true;
        showResult(resultDiv, null, false, null, null);
        var params = getParamsFromRow(row);
        try {
          var r = await fetch("/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              caseId: caseId,
              syncLimit: params.syncLimit,
              extractLimit: params.extractLimit,
              tenant: tp.tenant,
              purchaser: tp.purchaser,
            }),
            signal: controller.signal,
          });
          if (!r.ok || !r.body) {
            var errText = await r.text();
            try {
              var errJson = JSON.parse(errText);
              if (errJson.error) errText = errJson.error;
            } catch (_) {}
            showResult(resultDiv, { exitCode: 1, stdout: "", stderr: errText }, false);
            return;
          }
          var reader = r.body.getReader();
          var decoder = new TextDecoder();
          var buffer = "";
          var data = null;
          while (true) {
            var chunk = await reader.read();
            if (chunk.done) break;
            buffer += decoder.decode(chunk.value, { stream: true });
            var lines = buffer.split("\n");
            buffer = lines.pop() || "";
            for (var i = 0; i < lines.length; i++) {
              var line = lines[i].trim();
              if (!line) continue;
              try {
                var msg = JSON.parse(line);
                if (msg.type === "progress" && msg.percent != null) {
                  showResult(resultDiv, null, false, { percent: msg.percent, done: msg.done, total: msg.total }, null);
                } else if (msg.type === "sync_progress") {
                  showResult(resultDiv, null, false, null, { done: msg.done, total: msg.total });
                } else if (msg.type === "result") {
                  data = msg;
                } else if (msg.error) {
                  data = { exitCode: 1, stdout: "", stderr: msg.error };
                }
              } catch (_) {}
            }
          }
          if (buffer.trim()) {
            try {
              var msg = JSON.parse(buffer.trim());
              if (msg.type === "result") data = msg;
              else if (msg.error) data = { exitCode: 1, stdout: "", stderr: msg.error };
            } catch (_) {}
          }
          if (!data) {
            showResult(resultDiv, { exitCode: 1, stdout: "", stderr: "No result from server" }, false, null, null, caseId);
            return;
          }
          var expectFail = caseId.indexOf("N") === 0;
          var pass = expectFail ? data.exitCode !== 0 : data.exitCode === 0;
          showResult(resultDiv, data, pass, null, null, caseId);
        } catch (e) {
          if (e.name === "AbortError") {
            showResult(
              resultDiv,
              { exitCode: 130, stdout: "", stderr: "Stopped by user." },
              false,
              null,
              null,
              caseId,
            );
          } else {
            showResult(
              resultDiv,
              { exitCode: 1, stdout: "", stderr: e.message },
              false,
              null,
              null,
              caseId,
            );
          }
        } finally {
          btn.disabled = false;
          restoreResetBtn();
        }
      }

      var tbody = document.getElementById("rows");
      ROWS.forEach(function (c) {
        tbody.appendChild(renderRow(c, "rows"));
      });

      function downloadSyncReport(btn) {
        if (btn) btn.disabled = true;
        fetch("/api/sync-report")
          .then(function (r) { return r.blob(); })
          .then(function (blob) {
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "sync-report.html";
            a.click();
            URL.revokeObjectURL(a.href);
          })
          .catch(function () {})
          .then(function () {
            if (btn) btn.disabled = false;
          });
      }

      function downloadLatestHtmlReport(btn) {
        if (btn) btn.disabled = true;
        fetch("/api/reports")
          .then(function (r) { return r.json(); })
          .then(function (list) {
            var htmlReports = list.html || [];
            if (htmlReports.length === 0) {
              if (btn) btn.disabled = false;
              return;
            }
            var latest = htmlReports[0];
            var filename = latest.name;
            var url = "/api/reports/html/" + encodeURIComponent(filename);
            return fetch(url).then(function (r) { return r.blob(); }).then(function (blob) {
              var a = document.createElement("a");
              a.href = URL.createObjectURL(blob);
              a.download = filename;
              a.click();
              URL.revokeObjectURL(a.href);
            });
          })
          .catch(function () {})
          .then(function () {
            if (btn) btn.disabled = false;
          });
      }

      var BRAND_PURCHASERS = {
        "no-cow-026090539970-prod": ["DOT_FOODS", "KEHE", "UNFI"],
        "sundia-026090539970-prod": ["DOT_FOODS", "KEHE"],
        "tractor-beverage-026090539970-prod": ["DOT_FOODS"],
      };
      function refreshPurchaserOptions() {
        var brandSelect = document.getElementById("tenant-select");
        var purchaserSelect = document.getElementById("purchaser-select");
        if (!brandSelect || !purchaserSelect) return;
        var brand = brandSelect.value;
        if (brand === "") {
          purchaserSelect.disabled = true;
          purchaserSelect.innerHTML = '<option value="">Select</option><option value="all">All</option><option value="DOT_FOODS">DOT_FOODS</option><option value="KEHE">KEHE</option><option value="UNFI">UNFI</option>';
          purchaserSelect.value = "";
          return;
        }
        purchaserSelect.disabled = false;
        var current = purchaserSelect.value;
        var opts = brand !== "all" ? (BRAND_PURCHASERS[brand] || ["DOT_FOODS", "KEHE", "UNFI"]) : ["DOT_FOODS", "KEHE", "UNFI"];
        purchaserSelect.innerHTML = '<option value="">Select</option><option value="all">All</option>' + opts.map(function (p) { return '<option value="' + p + '">' + p + '</option>'; }).join("");
        if (current === "all" || opts.indexOf(current) !== -1) purchaserSelect.value = current;
        else purchaserSelect.value = "";
      }
      function showBrandError(msg) {
        var el = document.getElementById("brand-error");
        if (el) el.textContent = msg || "Please select a brand.";
      }
      function clearBrandError() {
        var el = document.getElementById("brand-error");
        if (el) el.textContent = "";
      }
      function showPurchaserError(msg) {
        var el = document.getElementById("purchaser-error");
        if (el) el.textContent = msg || "Please select a brand first.";
      }
      function clearPurchaserError() {
        var el = document.getElementById("purchaser-error");
        if (el) el.textContent = "";
      }
      (function () {
        var brandSelect = document.getElementById("tenant-select");
        var purchaserSelect = document.getElementById("purchaser-select");
        if (brandSelect && purchaserSelect) {
          brandSelect.addEventListener("change", function () {
            clearBrandError();
            clearPurchaserError();
            refreshPurchaserOptions();
          });
          purchaserSelect.addEventListener("change", function () {
            if (purchaserSelect.value && purchaserSelect.value !== "all" && (!brandSelect.value || brandSelect.value === "")) {
              showPurchaserError("Please select a brand first.");
            } else {
              clearPurchaserError();
            }
          });
          refreshPurchaserOptions();
        }
      })();
    </script>
  </body>
</html>
